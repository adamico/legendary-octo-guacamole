# Memory

This file serves as a persistent memory for the AI assistant to track long-term goals, project state, and important context.

## References

- [Architecture Documentation](ARCHITECTURE.md)
- [Design Goals](DESIGN.md)
- [Research Notes](RESEARCH.md)
- [Todo List](TODO.md)
- [Pizza Theme Ideas](ideas/pizza_theme.md)

## Current Context

The project is a Picotron game (Lua-based) using an ECS architecture.

### Workflow Preferences

- **Testing**: User handles manual testing - do not automatically launch picotron with `picotron -q` after code changes.

### Recent Activities

- **Migrated Combat Systems to Picobloc ECS (Phase 4)**:
  - **ECS Migration**:
    - **`Shooter.update`**: Refactored to use `world:query()` for input handling and cooldowns. Updated `Entities.spawn_projectile` to be compatible.
    - **`Melee.update`**: Refactored to use `world:query()` and `world:add_entity()` for hitbox spawning.
    - **`Effects` Module**: Updated all functions (`hit_impact`, `knockback`, `sticky_yolk`) to accept `world` and Entity IDs, replacing legacy `world.ent` and table access.
  - **Collision Handlers Refactor**:
    - Updated `combat_handlers.lua`, `obstacle_handlers.lua`, and `pickup_handlers.lua` to receive `world` context and use the new `Effects` API.
    - Fixed critical bug in `Physics.z_axis` (replaced `world:del_entity` with `world:remove_entity`).
  - **Physics Updates**: Added `slow_factor` support to `timers` component for "Sticky Yolk" effect.
  - **Documentation**: Updated `ARCHITECTURE.md` to reflect Phase 4 completion.

- **Start of Session**: Fixed various gameplay bugs including chest spawning mechanics, bomb interactions, and visual feedback.
  - **Chest Loot Improvements**:
    - Implemented smart spawning for chest loot: items now check for valid floor tiles (avoiding pits) and stagger their positions to prevent overlapping with each other.
    - Chests (and locked chests) are now immune to bomb explosions (fixed in `Bomber.destroy_obstacles_in_radius`).
  - **Visual Enhancements**:
    - **Pickup Floating Text**: Collecting items now shows a scaled-down 8x8 icon alongside the amount (e.g., `[Coin Icon] +1`).
    - **Text Stacking**: Floating texts now stagger vertically if they spawn near existing texts, preventing unreadable overlap.
- **Fixed Four Gameplay Bugs**:
  - **Chest Loot Spawn Distance**: Items from chests now spawn within 12px of the chest center (was 12-20px + random offset). If `snap_to_nearest_floor` moves an item too far, it's clamped back to max distance.
  - **Dasher Obstacle Detection**: Dashers in patrol state now set `hit_wall = true` when pushed out of obstacles, allowing them to change direction instead of getting stuck repeatedly against rocks/destructibles.
  - **Bombs No Longer Destroy Chests**: Removed `Explosion,Chest` and `Explosion,LockedChest` handlers - explosions now have no effect on chests.
  - **Infinite Inventory Cheat Shop Fix**: The `infinite_inventory` cheat now allows free shop purchases by skipping the coin check and deduction.
- **Fixed Chick Pathfinding Across Pits**:
  - **Problem**: Chicks would walk into pits when pathfinding failed - the fallback direct movement ignored walkability, and direct chase mode bypassed pathfinding entirely.
  - **Fix 1**: Removed direct movement fallback in `PathFollow.toward()` when no path exists. Now sets velocity to 0 instead of walking toward target.
  - **Fix 2**: Added line-of-sight check to direct chase - chicks only use direct movement when close AND there's no pit/obstacle between them. Exported `PathFollow.has_line_of_sight()` for this purpose.
  - **Fix 3**: When no path to enemy exists, chicks now return to the player (instead of wandering) and clear their blacklist to allow retargeting from new position.
  - **Fix 4**: Added `is_goal_tile` parameter to `Pathfinder.is_walkable()`. Both start AND goal tiles now skip ALL walkability checks since if an entity exists at that position, it's reachable.
  - **Fix 5**: Fixed obstacle tile coordinate mismatch. Rocks were spawned with -4px offset causing wrong tiles to be marked as blocked. Now stores `tile_x`/`tile_y` on obstacle entities.
- **Implemented Shop Room with Purchasable Items**:
  - **Layout**: Created `shop_layout` in `room_layout_data.lua` with 3 purchasable item pedestals using `"S"` (shop_item) feature.
  - **Entity**: Added `ShopItem` obstacle entity in `entities.lua` with sprite 58, hitbox 12x10 offset 2,6.
  - **Shop Items Config**: Created `src/game/config/shop_items.lua` with 6 purchasable items:
    - Heart Container ($15): +20 Max HP
    - Speed Boots ($10): +0.3 Speed
    - Bomb Pack ($5): +3 Bombs
    - Key Ring ($8): +2 Keys
    - Rapid Fire ($12): Fire Rate +25%
    - Long Range ($10): Range +40
  - **Purchase Logic**: Added `Player,ShopItem` handler in `obstacle_handlers.lua` - checks coins, applies effect, shows floating text, removes item.
  - **Price Display**: Added `Hud.draw_shop_prices()` in `hud.lua` to render item names and prices in world-space.
  - **Integration**: Updated `dungeon_manager.lua` to pre-select random shop items during generation and spawn ShopItem entities on room entry.
  - **Collision Layer**: Added `ShopItem = CollisionLayers.OBSTACLE` to `collision.lua`.
- **Reorganized Debug UI**:
  - **Groups**: Divided the F1 debug panel into logical "Cheats" and "Debug" sections using headers.
  - **Toggles**: Added interactive toggles for `show_grid`, `show_combat_timer`, and `show_pathfinding` alongside existing toggles.
  - **Visuals**: Used `_ACCENT1_color` (gray) for headers to distinguish them from interactive buttons and info groups.
- **Implemented Infinite Inventory Cheat**:
  - **Feature**: Added `infinite_inventory` cheat to `GameState.cheats` (F6 shortcut).
  - **Logic**: When active, bombs (in `bomber.lua`) and keys (in `obstacle_handlers.lua`) are not consumed, and actions requiring them can be performed even with 0 in inventory.
  - **UI**: Added a toggle for `infinite_inventory` in the debug UI.
- **Implemented Combat Timer Debug Configuration**:
  - **Feature**: Added `show_combat_timer` toggle to `GameState.debug`.
  - **Config**: Added `Hud.combat_timer` to `ui.lua` with configurable `x`, `y`, and `color`.
  - **Logic**: The combat timer is now hidden by default and only renders when the debug flag is active, using properties from the UI config.
- **Fixed XP Bar UI Configuration Usage**:
  - **Issue**: The XP bar in `src/ui/xp_bar.lua` was using hardcoded values for its vertical position, height, and colors, ignoring the values defined in `src/game/config/ui.lua`.
  - **Fix**: Updated `XpBar.draw()` to use `GameConstants.XpBar` for `y` position, `height`, `padding`, and colors. Also replaced hardcoded `480` and `50` with `SCREEN_WIDTH` and `GameConstants.Player.base_xp_to_level`.
  - **Result**: The XP bar now respects the `y = 256` configuration and uses project-wide constants.
- **Prevented DNAStrand and Loot Pickups from Spawning on Pits**:
  - **Issue**: DNA strands (XP) and other loot (Coins, Bombs, Keys) were sometimes spawning over pit tiles when enemies died or chests were opened, making them unreachable.
  - **Fix**: Integrated `DungeonManager.snap_to_nearest_floor()` into `DeathHandlers.Enemy` in `death_handlers.lua` and into `destroy_destructible` and `open_chest` in `obstacle_handlers.lua`.
  - **Result**: All pickups spawned from combat or environmental destruction now automatically snap to the nearest walkable floor tile if they would have landed on a pit.
- **Implemented Player XP/Leveling System**:
  - **Config**: Added `starting_level`, `starting_xp`, `base_xp_to_level` (50), `xp_per_level_linear` (25) to `player.lua`.
  - **Entity XP Values**: Added `xp_value` to all enemies in `entities.lua`: Skulker (10), Shooter (15), Dasher (25), Skull (50).
  - **DNAStrand Pickup**: New pickup type for XP drops (sprite 199), defined in `entities.lua` with `pickup_effect = "xp"`.
  - **Death Handlers**: Modified `death_handlers.lua` to spawn DNAStrand on enemy death.
  - **Pickup Handler**: Added `PickupEffects.xp` in `pickup_handlers.lua` to grant XP on collection.
  - **Leveling Utility**: Created `src/utils/leveling.lua` with `check_level_up()` - checks XP threshold and auto-applies +5% max HP per level (Phase 1).
  - **XP Bar UI**: Created `src/ui/xp_bar.lua` rendering at screen bottom with level text and XP progress.
  - **Integration**: Updated `play.lua` import, update loop call, draw call, and debug panel display.
  - **Events**: Added `LEVEL_UP` event to `events.lua` for future level-up UI modal.
- **Implemented Dasher Stunning on Obstacle Collision**:
  - **Logic**: Dashers now enter the `stunned` state when colliding with obstacles (Rocks, Destructibles, Chests) while in the `dash` state, matching their existing behavior for wall and player collisions.
  - **Implementation**: Added `push_out_enemy` helper in `obstacle_handlers.lua` to manage spatial resolution and Dasher collision state triggers.
  - **Config**: Added `Chest` and `LockedChest` to `EntityCollisionLayer` for explicit collision filtering.
- **Implemented Chest and Locked Chest Room Feature**:
  - **Feature Types**: Added `"C"` for chest and `"L"` for locked chest to `FEATURE_LEGEND` in `room_layout_data.lua`.
  - **Entity Configs**: Added `Chest` (sprite 166) and `LockedChest` (sprite 167) to `GameConstants.Obstacle` in `entities.lua`.
    - Normal chests: `loot_min=1`, `loot_max=3` (drop 1-3 pickups)
    - Locked chests: `loot_min=2`, `loot_max=6` (drop 2-6 pickups), `key_cost=1`
  - **Collision Handlers**: Added handlers in `obstacle_handlers.lua`:
    - Player touching chest = opens it (checks for key on locked chests)
    - Melee/Projectile/Explosion can open chests (bombs force locked chests open only with key)
    - Loot table: Coins (40%), Bombs (25%), Health (20%), Keys (15%)
  - **Spawn Validation**: Updated both `is_valid_spawn_tile()` in `dungeon_manager.lua` and `is_tile_valid()` in `spawner.lua` to block enemy spawns on chest/locked chest tiles.
  - **Example Layouts**: Added `treasure_vault` (locked chest in center) and `chest_corners` (4 chests in corners).
- **Implemented Level Seed for Reproducible Dungeons**:
  - Added `level_seed` and `current_seed` fields to `GameState` in `game_state.lua`.
  - Set seed with `srand()` before `DungeonManager.init()` in `play.lua`.
  - If `level_seed` is nil (default), a random seed is generated from `time() * 1000`.
  - Seed is logged to console and displayed in F1 debug UI for easy copy/paste when reproducing bugs.
- **Fixed Chick AI Pathfinding Issues**:
  - **Stuck Detection & Recovery**: Chicks now abandon unreachable targets after ~1 second of failed pathfinding (`MAX_CHASE_STUCK_FRAMES = 60`). While stuck, they wander randomly instead of standing still.
  - **Path Smoothing**: Added `has_line_of_sight()` function in `path_follow.lua`. Entities now skip intermediate waypoints and move directly to the target (or furthest visible waypoint), eliminating zig-zag movement.
  - **Hybrid Chase Movement**: When within 48 pixels of target, use direct `Chase.toward()` instead of pathfinding. This prevents the attack-knockback-wander cycle where chicks would back off after each hit.
  - **Debug Visualization**: Added `show_pathfinding` flag in `game_state.lua` with FSM state display, attack range circles, and path/distance visualization.
- **Fixed Wave Pattern Spawning Outside Room Bounds**:
  - **Problem**: Skulker enemies from wave patterns (e.g., "ambush") were spawning outside the room or on pit tiles when the layout (e.g., "corridor_vertical") had pit tiles restricting the walkable area.
  - **Root Cause**: `DungeonManager.is_valid_spawn_tile()` didn't check room inner bounds, so `snap_to_nearest_floor()` could return positions that were technically floor tiles but outside the room's walkable area.
  - **Fix**: Added explicit room inner bounds check in `is_valid_spawn_tile()`. Now checks: (1) map bounds, (2) room inner bounds when room provided, (3) floor tile, (4) pit/feature flags. The spawner skips enemies when nudge finds no valid position.
- **Cleanup**:
  - **Removed Chick AI Debug Logging**: Cleaned up `Log.trace` statements used for debugging Dasher detection and selection in `chick.lua`.
- **Implemented Sticky Yolk & Face-Hugger Combat Mechanics**:
  - **Removed Knockback**: Egg projectiles no longer push enemies away (was counter-productive for minion swarm).
  - **Sticky Yolk Effect**: Added stun (12 frames ~0.2s) + slow (60 frames ~1s at 50% speed) on all egg impacts.
    - Config in `player.lua`: `egg_stun_duration`, `egg_slow_duration`, `egg_slow_factor`.
    - New `Effects.apply_sticky_yolk()` in `effects.lua`.
    - Physics handles `stun_timer` (zero velocity) and `slow_timer` (reduced max_speed) in `apply_acceleration()`.
  - **Face-Hugger**: Chicks spawned from direct enemy hits attach to the target for ~1s (60 frames).
    - `combat_handlers.lua`: Spawns egg at enemy position with `attachment_target` and `attachment_timer`.
    - `egg.lua`: Passes attachment data to spawned chick.
    - `chick.lua`: Attached chicks follow enemy, get guaranteed attacks, then detach when timer expires or enemy dies.
  - **Target Painting**: Enemies hit by eggs become priority targets for all chicks (2x vision range to painted target).
    - `chick.lua`: Module now exports `paint_target()`, `clear_target()`, and `get_painted_target()`.
    - `combat_handlers.lua`: Calls `AI.ChickAI.paint_target(enemy)` on egg impacts.
    - `play.lua`: Calls `AI.ChickAI.clear_target()` on room transition.
- **Optimized Chick AI Performance**:
  - Fixed CPU spikes when 2-3 chicks are on screen, especially when paths fail.
  - `chick.lua`: Cached player/room queries once per frame, use squared distances for range comparisons.
  - `seek_food.lua`: Removed intermediate table allocation in ECS query.
  - `path_follow.lua`: Added frame budget guard (max 2 A* per frame), increased `DIRECT_MOVE_DIST` to 64px, improved entity staggering.
  - `systems/ai.lua`: Reset pathfinding frame budget at start of each update.
  - `lua-star.lua`: Added `MAX_NODES=150` limit to prevent exhaustive search when no path exists.
  - `pathfinder.lua`: Added failed path cache (2s TTL), reduced `SEARCH_MARGIN` from 15 to 8 tiles.
- **Implemented AI Pathfinding System**:
  - Added `lua-star` A* library (`lib/lua-star/lua-star.lua`) from Wesley Werner.
  - Created `lib/lua-star/pathfinder.lua` Picotron wrapper with walkability integration.
  - Created `src/ai/primitives/path_follow.lua` AI primitive with waypoint tracking, stuck detection, and automatic re-pathing.
  - Updated `src/ai/minions/chick.lua` to use PathFollow for `following`, `chasing`, and `seeking_food` states.
  - Chicks now navigate around obstacles using A* instead of walking into walls.
- **Implemented Chick Minion Health & Drain**:
  - Added 20 HP to chicks (they now have `hp = 20`).
  - Added `hp_drain_rate = 60` config property (frames between each 1 HP drain).
  - Extended `systems/timers.lua` to handle HP drain for any entity with `hp_drain_rate`.
  - Chicks now lose 1 HP per second and are deleted when HP reaches 0.
- **Refined Egg Projectile Logic (3-Outcome System)**:
  - Replaced two-roll (integrity+fertility) system with a single-roll 3-outcome mechanic (33% each):
    - **Heavy Impact**: Deals high damage (15), no refund.
    - **The Hatching**: Spawns a chick minion, deals no damage.
    - **Parasitic Drain**: Deals low damage (5), drops 5 HP blood glob (refund).
  - Applied outcomes consistently across **Enemy**, **Wall**, **Obstacle**, and **Ground** collisions.
  - Updated `Player` config, `Shooter` system, and all collision handlers.
  - Documented flow in `DESIGN.md`.
- **Created Rendering Architecture Documentation**:
  - Created `docs/architecture/rendering.md` covering:
    - **Y-Sorted Depth**: Foot-based sorting for 2.5D visual layering.
    - **Z-Axis Simulation**: Visual vertical displacement (`draw_y = y - z`) with ground-anchored hitboxes and shadows.
    - **Shadow System**: Entity-based shadows with dynamic sizing and parent syncing.
    - **Lighting/Palette**: Extended palette usage for spotlights (colors 32-47) and darkness (colors 48-63).
    - **Sprite Effects**: 8-neighbor outlines, flash timers, composite sprites, and procedural death animations.
  - Linked the new document in `ARCHITECTURE.md` and marked as done in `TODO.md`.
- **Implemented Vertical vs Horizontal Projectile Trajectory Behavior**:
  - **Problem**: For horizontal shots, the egg flies elevated (z > 0) and the sprite visually drops to the shadow during landing. For vertical shots (up/down), this looked wrong because the collision point is at the visual position, not the shadow position.
  - **Solution**: Added `vertical_shot` flag to projectiles. During the drop phase, vertical shots keep the visual Y constant while the shadow (entity.y) moves toward the sprite. Horizontal shots behave normally (sprite drops to shadow).
  - **Key Insight**: `get_hitbox()` returns the hitbox at the VISUAL position (already accounting for z), so spawning pickups at hitbox center works correctly for both trajectory types.
  - **Ground Collision Fix**: When z <= 0, must set BOTH `z = 0` AND `vel_z = 0` to prevent runaway negative values.
  - **Y Adjustment Guard**: Only apply the vertical shot Y adjustment when `z > 0` (still falling). Once grounded, stop adjusting Y.
  - **Pickup Inheritance**: Pickups can inherit `vertical_shot` flag from projectiles to get correct drop animation behavior.
- **Fixed Three Collision Bugs**:
  - **Push-Out Respects Solid Tiles**: Modified `push_out()` in `obstacle_handlers.lua` to check if push direction leads into a wall tile. Uses `qsort` to try push options in order of minimum penetration, selecting the first one that doesn't collide with solid tiles.
  - **Room Transition Uses Hitbox Center**: Modified `check_trigger()` in `collision.lua` to use hitbox center rather than entity top-left position for boundary detection. Fixes false room transitions when tall sprites walk into walls.
  - **Fixed Double Pickup Spawn**: Added `hit_obstacle` guard flag to prevent projectiles from spawning multiple pickups when hitting multiple obstacles in the same frame.
- **Implemented Z-Elevation Collision Filtering**: Added asymmetric Z-axis collision checks for projectiles:
  - **Concept**: Enemy projectiles above the player's `height_z` pass overhead without hitting.
  - **Player Config**: Added `height_z = 25` to Player config (covers human body, ignores chicken on head).
  - **Collision Logic**: Modified `collision.lua` to check `projectile.z <= target.height_z` for `EnemyProjectile â†’ Player` collisions only.
  - **Asymmetric**: Player eggs still hit all enemies regardless of Z; only incoming enemy projectiles are filtered.
  - **Future-Proof**: Other entities can define `height_z` to enable vertical collision filtering.
- **Split game_config.lua into Modules**: Refactored the 730-line monolithic config into focused sub-modules:
  - **Structure**: `src/game/config/` with `tiles.lua`, `player.lua`, `entities.lua`, `effects.lua`, `ui.lua`, `controls.lua`, `collision.lua`
  - **Main Aggregator**: `game_config.lua` is now a 48-line file that imports and merges all sub-modules
  - **Globals Preserved**: Tile constants remain as globals (loaded via `require` with no return)
- **Implemented Egg Hatching System**: Player egg projectiles now hatch into chicks (passive wandering minions) when landing:
  - **New Minion Section**: Added `GameConstants.Minion.Chick` to `game_config.lua` for player-summoned entities.
  - **Minion Factory**: Created `entities/minion.lua` using the Type Object pattern.
  - **Chick AI**: Created `ai/enemies/chick.lua` with wandering behavior via the `Wander` primitive.
  - **AI Dispatch**: Added `AI.dispatch_minion()` to `ai/init.lua` and minion processing to `systems/ai.lua`.
  - **Landing Logic**: Modified `physics.lua` to spawn chicks instead of pickups when eggs land.
- **Implemented Overheal System**: Added stackable bonus health that acts as temporary max HP (like Isaac's Soul Hearts):
  - **Accumulation**: Excess healing past `max_hp` now accumulates in `overflow_hp` (already existed, now properly used).
  - **Damage Absorption**: Added `apply_damage_with_overheal()` helper in `combat_handlers.lua` - overheal is consumed before base HP.
  - **Visual Feedback**: Health bar in `ui.lua` now renders overheal segments in light blue (color 12) after green HP segments.
  - **Debug Panel**: Added `overheal` and `hp/max_hp` display to F1 debug panel.
  - **Foundation for Powerups**: Overheal is tracked separately to enable future powerup effects (regen-overheal, shield-overheal, damage-overheal).
- **Implemented Bomb Entity System**: Added bomb placement and explosion mechanics:
  - **Input**: X button places a bomb at the player's center tile-aligned position (consumes 1 bomb from inventory).
  - **PlacedBomb Entity**: Sprite 22, 3-second fuse (180 frames), 1-tile explosion radius.
  - **Explosion Entity**: Sprite 27, 30-frame lifespan, spawns in 3x3 grid around bomb on detonation.
  - **Destruction**: Explosions destroy both destructibles (with loot drops) and rocks (normally indestructible).
  - **Combat**: Explosions damage players (20 HP) and enemies (20 HP) with radial knockback from bomb center.
  - **Collision Layer**: New `EXPLOSION` layer (128) that hits Player, Enemy, and Obstacle.
  - **Files**: `entities/bomb.lua`, `entities/explosion.lua`, `systems/bomber.lua`, updated `combat_handlers.lua`, `obstacle_handlers.lua`.
- **Fixed Shooting Not Killing Player**: Changed `shooter.lua` to clamp HP to minimum 1 after shot cost deduction, so firing the last health segment leaves player at 1 HP instead of killing them.
- **Fixed Enemy Spawn Validation**: Enhanced `spawner.lua` spawn validation to:
  - **Room Bounds Check**: Added explicit room bounds validation in both tile and pixel space to prevent enemies spawning outside the room interior.
  - **Direct Pit Check**: Added `mget()` check for `PIT_TILE` (85) to catch pits in layouts without grid pattern data.
  - **Improved Nudging**: The `nudge_to_valid()` now respects room bounds so enemies can't be nudged outside the room.
