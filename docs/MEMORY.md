# Memory

This file serves as a persistent memory for the AI assistant to track long-term goals, project state, and important context.

## References

- [Architecture Documentation](ARCHITECTURE.md)
- [Design Goals](DESIGN.md)
- [Research Notes](RESEARCH.md)
- [Todo List](TODO.md)
- [Pizza Theme Ideas](ideas/pizza_theme.md)

## Current Context

The project is a Picotron game (Lua-based) using an ECS architecture.

### Workflow Preferences

- **Testing**: User handles manual testing - do not automatically launch picotron with `picotron -q` after code changes.

### Recent Activities

- **Fixed Shooting Not Killing Player**: Changed `shooter.lua` to clamp HP to minimum 1 after shot cost deduction, so firing the last health segment leaves player at 1 HP instead of killing them.
- **Fixed Enemy Spawn Validation**: Enhanced `spawner.lua` spawn validation to:
  - **Room Bounds Check**: Added explicit room bounds validation in both tile and pixel space to prevent enemies spawning outside the room interior.
  - **Direct Pit Check**: Added `mget()` check for `PIT_TILE` (85) to catch pits in layouts without grid pattern data.
  - **Improved Nudging**: The `nudge_to_valid()` now respects room bounds so enemies can't be nudged outside the room.
- **Reworked Skull Enemy Mechanics**:
  - **Simplified Entity Type**: Changed Skull's `entity_type` from `"Skull"` to `"Enemy"` so it uses standard `Projectile,Enemy` and `MeleeHitbox,Enemy` handlers without needing separate skull-specific handlers.
  - **Increased HP**: Changed skull HP from 1 to 100 (requires ~5 shots to kill).
  - **Drop Chance**: Added `drop_chance` property (50%) to Entity config. The `DeathHandlers.Enemy` now checks this property (defaults to 100% for regular enemies).
- **Fixed Collision System Bugs**:
  - **Double Pickup Collection**: Added a `collected` guard flag to `handle_pickup_collection()` to prevent pickups from triggering their effect multiple times when touched across multiple frames.
  - **Melee Attacks Not Working**: Melee hitboxes were missing from collision checks because they lacked the `velocity` tag. Added `world.sys("collidable,melee_hitbox", Systems.resolve_entities)()` to the collision resolution phase in `play.lua`.
  - **MeleeHitbox Collision Layer**: Added `MeleeHitbox` to `EntityCollisionLayer` (using `PLAYER_PROJECTILE` layer).
- **Implemented Room Layout System**: Added Isaac-style carving patterns for room interiors with features (rocks, pits, destructibles):
  - **9×7 Grid System**: Compact ASCII grid maps to 27×14 room interior (each cell = 3×2 tiles). Example: `"R.......R"`.
  - **cell_pattern Positioning**: Optional array that cycles through features, specifying placement within each 3×2 cell:
    - `"tl"`, `"tm"`, `"tr"` = single tile in top row
    - `"bl"`, `"bm"`, `"br"` = single tile in bottom row
    - `"f"` = full 3×2 block (default)
  - **Data/Code Separation**: Layout definitions in `src/data/room_layout_data.lua`. Logic in `room_layouts.lua` via `get_all_features()`.
  - **Room Visibility Filtering**: Obstacle entities have `room_key` property; `Rendering.set_active_rooms()` filters rendering to only show obstacles from current room(s).
  - **Collision Detection**: `find_solid_tile()` checks `room.rocks` and `room.destructibles` for entity collision.
  - **Spawn Filtering**: Spawner validates tile area around spawn points to prevent enemies near obstacles.
  - **Generation Order**: Floor tiles carved first → autotiling → obstacles placed (fixes wall autotiling around rocks).
- **Categorized TODO List**: Reorganized `docs/TODO.md` into themed categories (Combat, AI, World, Items, Visuals) for better project management.
- **Implemented Player Stats System**: Decoupled combat stats from static projectile configuration, moving them to the `Player` entity to enable dynamic builds and powerups.
  - **Stats**: `shot_speed`, `range` (lifetime), `fire_rate`, and `knockback` are now player properties.
  - **Dynamic Damage**: Introduced `max_hp_to_damage_ratio` (default 0.2). Damage is derived as `max_hp * ratio`, creating a synergy where Health Up items also increase Damage.
  - **Inventory**: Added `coins`, `keys`, `bombs` slots to the player entity.
  - **Refactored Shooting**: `Projectile.spawn` and `Shooter` system now accept stat overrides, allowing the shooter's current stats to dictate projectile behavior.
  - **Debug UI**: Added a **Player Stats** group to the F1 debug panel displaying real-time combat stats and inventory counts.
- **Implemented Projectile Range & Visual Arc**:
  - **Z-Axis Simulation**: Projectiles now have `z`, `vel_z`, and `gravity_z` properties. Physics system updates Z position and applies gravity.
  - **Visual Arc**: Rendering system offsets sprite Y by Z height (`y - z`), creating a 3D parabolic effect while keeping the logical hitbox grounded.
  - **Delayed Gravity**: Gravity is applied only in the last 25% of the projectile's lifetime, creating a horizontal flight phase followed by a drop.
  - **Ground Impact**: When projectiles hit the ground (Z=0 at range limit), they spawn a `ProjectilePickup` (chance for hearts).
  - **Range Stat**: Player `range` stat determines projectile lifetime.
- **Refactored Stats & Combat**:
  - **Dynamic Player Stats**: Converted flat `shot_cost` and `damage` to dynamic ratios (`max_hp_to_shot_cost_ratio`, `max_hp_to_damage_ratio`), allowing stats to scale with max HP.
  - **Enemy Stats Standardization**: Renamed `speed` to `max_speed` across all enemies and AI scripts for consistency. Added proper combat stats (`shot_speed`, `damage`, `range`) to Shooter enemies.
  - **Precision Aiming**: Updated Shooter AI and `EntityUtils.get_center()` to target the player's visual center (accounting for Z-height) rather than top-left corner.
  - **Visual Alignment**: Adjusted `Projectile.spawn` and `Laser` configuration to align projectile sprites with the shooter's visual center vs collision hitbox.
  - **Pickup Physics**: `ProjectilePickup` now inherits `z` height from its parent projectile and uses gravity (`velocity` tag) to fall naturally when spawning on walls/air.
- **Enhanced Minimap with Smart Rotation**:
  - Implemented a 4-quadrant rotation system (TR -> BR -> BL -> TL) where the minimap flees the player.
  - **Smart Approach Logic**: Uses player velocity to determine rotation direction (CW/ACW). Horizontal approach triggers vertical flee; vertical approach triggers horizontal flee.
  - **Smooth Tweening**: Refactored `minimap.lua` to interpolate both X and Y coordinates for fluid transitions.
  - **Dynamic Trigger**: Overlap detection now follows the minimap's visual position.
- **Implemented Isaac-Style Minimap UI**:
  - **New `src/ui/minimap.lua`**: Displays dungeon layout in top-right corner with:
    - Visited rooms as filled cells (light gray)
    - Current room highlighted (white with border)
    - Adjacent unexplored rooms shown as outlines (fog of war)
    - Special room icons (10x10 sprites): start=192, shop=193, treasure=194, boss=195
  - **New `src/ui/` module**: Created UI namespace aggregator pattern with `init.lua` and root redirect.
  - **Integration**: Minimap initialized and updated in `play.lua` via `Events.ROOM_TRANSITION`.
- **Implemented Game Over Screen & Scene Transition**:
  - Added `Events.GAME_OVER` to handle scene changes from anywhere.
  - Updated `DeathHandlers.Player` to emit `Events.GAME_OVER` when the player dies.
  - Refactored `main.lua` to listen for the event and switch to the "GameOver" state.
  - Polished `src/scenes/game_over.lua` with better visuals (centered Band, red text, and pgui buttons).
  - Fixed a bug in `play.lua` by moving ECS world initialization into `enteredState` to ensure a fresh start on restart.
- **Increased Room Generation Count**: Updated `TARGET_ROOM_COUNT` to 12 in `dungeon_manager.lua` for larger dungeons.
- **Separated Game Config from State**: Created new `src/game/` folder containing:
  - `game_config.lua` (immutable configuration, renamed from constants.lua)
  - `game_state.lua` (mutable runtime state: cheats, debug flags)
  - `events.lua` (pub/sub event system, moved from utils/)
  - `init.lua` aggregator exposing `Game.Config`, `Game.State`, and `Game.Events`
- **Implemented Friction-Based Knockback**: Refactored `Effects.apply_knockback()` to use separate `knockback_vel_x/y` properties that decay at 0.75 friction per frame in `physics.lua`. Knockback strength now directly controls initial velocity, with natural deceleration over ~5 frames.
- **Fixed Missing Attack Animation**: Added `fsm:attack()` calls to `shooter.lua` and `melee.lua` to trigger the player's attack animation when firing/meleeing.
- **Implemented Isaac-Style Wave Pattern System**: Replaced random enemy spawning with pre-defined patterns using a positional DSL in `src/world/wave_patterns.lua`.
- **Implemented Pub/Sub Event System**: Centralized event handling using [beholder.lua](file:///home/kc00l/game_dev/pizak/lib/beholder.lua/beholder.lua) with typed constants (`Events.ROOM_CLEAR`, `Events.ROOM_TRANSITION`).
- **Implemented Floating Damage/Heal Numbers**:
  - **New `systems/floating_text.lua`**: Displays floating text above entities when they take damage (red) or heal (green). Numbers rise upward and fade out over configurable duration.
  - **Integration Points**: Collision handlers spawn damage text on hit; pickup collection and room-clear callbacks spawn heal text.
  - **Configuration**: `GameConstants.FloatingText` provides tweakable parameters (rise speed, duration, colors, spread).
- **Implemented Visual Effects**:
  - **Pickup Shadow**: Added `shadow` tag and properties to `ProjectilePickup` in `constants.lua` so embedded projectiles render with shadows.
  - **Batch-Optimized Sprite Outline**: Added `Rendering.draw_outlined()` function using Picotron's batch GFX operations (`userdata("f64")` + batch `spr()`) for 8 outline draws in a single call.
- **Implemented Room-Clear Health Regen**: Player now heals 1 segment (`max_hp / 5` = 20 HP) when clearing a combat room. The passive time-based regen (`health_regen.lua`) has been disabled (`regen_rate = 0`) but kept for future use.
- **Fixed Door Guidance System**: Resolved a long-standing issue where the wall-sliding guidance was broken due to incorrect door detection (checking for map tiles instead of room metadata) and buggy velocity calculation.
  - Refactored `apply_door_guidance` to use `Room` metadata for robust door detection.
  - Corrected the nudge logic to apply velocity to the orthogonal axis (e.g., nudge Y when colliding on X).
  - Optimized map collision to avoid redundant `find_solid_tile` calls.
- **Unified Entity Spawning for Shadows**: Refactored all entity factories (`Player`, `Enemy`, `Projectile`, `Pickup`) to use `Utils.spawn_entity`, ensuring that any entity with the "shadow" tag automatically spawns a linked shadow entity. Specifically updated `pickup.lua` which was previously using `world.ent` directly.
- **Refactored Lighting and Shadow Palette Logic**: Centralized common code between lighting and shadow systems:
  - **New `src/utils/palette.lua`**: Contains Picotron base colors and `init_extended_palette()` logic for generating lighter/darker color variants.
  - **Centralized Constants**: Moved `LIGHTING_SPOTLIGHT_COLOR` and `LIGHTING_SHADOW_COLOR` to `src/constants.lua`.
  - **Simplified Systems**: `src/systems/lighting.lua` and `src/systems/shadows.lua` now use the centralized utility and constants, removing duplicated logic and color definitions.
- **Unified Module Structure (Aggregators Everywhere)**: Standardized the entire codebase to use a unified, namespaced module pattern for improved clarity, discoverability, and namespace safety:
  - **Namespace Aggregators**: Created `init.lua` in all major directories (`physics/`, `ai/`, `lifecycle/`, `world/`, `utils/`, `entities/`, `systems/`, `scenes/`) to aggregate and re-export sub-modules via a single table.
  - **Explicit Namespacing**: Refactored the entire codebase (all `require` statements) to use explicit sub-paths (e.g., `local Collision = require("physics/collision")` or `local World = require("world")`).
  - **Root Redirects**: Created root-level redirect files (e.g., `src/physics.lua`) that simply `return require("physics/init")`, allowing both `require("physics")` and `require("physics/collision")` to work seamlessly.
  - **Simplified Search Paths**: Cleaned up `main.lua` to only include `lib/` and `src/` in `add_module_path`, removing all recursive subfolder additions.
  - **Namespace Safety**: Renamed potentially conflicting modules (e.g., AI behaviors) with explicit suffixes (`_behavior.lua`) and grouped them under their respective namespaces.
- **Dissolved `combat.lua` Module**: Major architectural refactoring to establish proper system boundaries and generic ECS tags:
  - **New `systems/shooter.lua`**: Generic shooting system for ANY entity with `shooter` tag. Works for both player and enemies. Uses `health_as_ammo` flag instead of type checks.
  - **New `systems/timers.lua`**: Generic countdown timer system for entities with `timers` tag. Handles `invuln_timer` and `shoot_cooldown`.
  - **New `systems/health_regen.lua`**: Generic health regeneration for entities with `health_regen` tag. Configurable triggers and optional overflow banking.
  - **New `lifecycle/death_handlers.lua`**: Entity death behavior registry for FSM-based deaths (loot, game over). This is a registry/utility, not an ECS system.
  - **Restructured AI Module**: Moved from flat `*_behavior.lua` files to a `primitives/ + enemies/` hierarchy:
    - `ai/primitives/wander.lua` - Stateless random movement helper
    - `ai/primitives/chase.lua` - Stateless chase/flee/orbit helper
    - `ai/enemies/{skulker,skull,shooter,dasher}.lua` - Per-enemy-type FSM controllers that compose primitives
  - Enemy profiles now match `enemy_type` names in `constants.lua` for trivial dispatch lookup.
  - **Player entity updated**: Added `health_regen`, `timers`, `shooter` tags and new properties (`health_as_ammo`, `overflow_banking`, `regen_trigger_field`).
  - **Shooter enemy updated**: Added `shooter`, `timers` tags in `constants.lua`. AI now sets `shoot_dir_x/y` while system handles spawning.
  - **Added `Projectile.spawn_centered()`**: Helper for hitbox-centered projectile spawning, now exported via `entities/init.lua`.
- **Optimized Collision System**: Comprehensive refactoring of collision detection for massive performance gains and better code organization:
  - **Priority 1 (Performance):**
    - Removed dead code (`get_overlapping_tile` function).
    - Un-exported unused helpers (`check_overlap`, `is_solid`) - now internal only.
    - Optimized entity collisions: checks overlap BEFORE string concatenation and table lookup (~200 fewer string operations/frame).
    - Added early rejection when no handler exists.
    - **Result**: ~50% reduction in collision overhead.
  - **Priority 2 (Code Quality):**
    - Extracted magic numbers: `TILE_EDGE_TOLERANCE` (0.001) and `DOOR_GUIDANCE_MULTIPLIER` (1.5) to `constants.lua`.
    - Separated concerns: Extracted door guidance into dedicated `apply_door_guidance()` function.
    - Simplified `check_trigger`: Removed unnecessary handler indirection.
    - Removed dead handler (`Handlers.tile["Player,Transition"]`).
  - **Priority 3 (Spatial Optimization):**
    - **Spatial Grid Partitioning**: 64px cells (4 tiles) for broad-phase collision detection.
    - **Bitmasking Collision Layers**: 6 collision layers (PLAYER, ENEMY, PLAYER_PROJECTILE, ENEMY_PROJECTILE, PICKUP, WORLD) with bitmasks defining collision rules.
    - Layer checks use single bitwise AND operation vs table lookups.
    - **Result**: 70-85% reduction in collision checks (400 → 40-60 checks/frame for 20 entities).
  - **OOP Refactoring & Module Restructuring:**
    - **New `src/utils/hitbox_utils.lua`**: Reusable `get_hitbox()` utility, usable across collision, AI, and rendering systems.
    - **New `src/utils/entity_utils.lua`**: Moved from `entities/utils.lua` for better organization. Contains shared entity utilities: `get_config()`, `get_direction_name()`, `spawn_entity()`.
    - **New `src/physics/` folder**: Moved all collision code from `systems/` to dedicated physics module.
      - `collision.lua`: Main collision logic (renamed from `init.lua` to avoid ambiguity).
      - `spatial_grid.lua`: SpatialGrid class for spatial partitioning.
      - `collision_filter.lua`: CollisionFilter class for bitmasking layer checks.
      - `handlers.lua`: Collision response handlers.
    - Each component now testable in isolation with clear responsibilities.
    - Updated `systems/rendering.lua` to import `HitboxUtils` directly instead of using removed `Collision.get_hitbox`.
    - Updated `systems/combat.lua` to use `HitboxUtils` for projectile spawn positioning (replaces hardcoded 16x16 size with proper hitbox-based centering).
- **Renamed `dungeon/` to `world/`**: For naming coherence with ECS "world" concept and overall architecture consistency.
- **Extracted Room Renderer Module**: Refactored `src/scenes/play.lua` (358→152 lines, ~57% reduction) by extracting logic into appropriate modules:
  - **New `src/world/room_renderer.lua`**: Door visibility management, adjacent room floor masking, void area coverage, high-level draw helpers (`draw_scrolling()`, `draw_exploring()`).
  - **Moved to `DungeonManager`**: `setup_room()` (room entry spawning/lifecycle), `check_room_clear()` (enemy count and room clear transition).
- **Simplified Module Requires**: Added `src/ai/` to the module search path in `main.lua` and refactored all `require` statements to use simple filenames (e.g., `require("emotions")` instead of `require("systems/emotions")`). This follows the project's established convention for cleaner codebase organization.
- **Unified Enemy AI to FSMs**: Refactored `chaser.lua` and `shooter.lua` to use `lua-state-machine` FSMs with emotion callbacks, matching the `dasher.lua` pattern:
  - **Chaser FSM**: States: `wandering`, `chasing`, `puzzled`. Callbacks trigger "alert" on spot and "confused" during puzzled pause before wandering.
  - **Shooter FSM**: States: `wandering`, `engaging`, `puzzled`. Same emotion callbacks and puzzled state as Chaser.
  - **Dasher FSM**: Added "stunned" emotion (★ in yellow) when entering stun state after collision.
  - Removed all ad-hoc `ai_state` string tracking in favor of FSM `fsm:is()` checks.
- **Brainstormed Pizza-Themed Collectibles**: Created `docs/ideas/pizza_theme.md` with ideas for currency (Slices), keys (Dough Knots), bombs (Spicy Meatballs), and "Ammunition Mods" (Garlic, Anchovy, Pineapple) that integrate with the health-as-ammo mechanic.
- **AI Behavior Modularization**: Extracted individual AI behaviors from the monolithic `src/systems/ai.lua` into a new `src/ai/` directory (`chaser.lua`, `shooter.lua`, `dasher.lua`). Refactored `src/systems/ai.lua` into a clean dispatcher module.
- **Renamed Redundant AI Function**: Renamed `AI.enemy_ai` to `AI.update` and updated its export in `Systems` to `Systems.ai` for better consistency with other systems.
- **Implemented Shooter Vision Range**: Added a distance-based activation check to the Shooter AI. Shooters now remain idle until the player enters their `vision_range` (200 pixels).
- **Implemented Random Wandering Behavior**: Created reusable `src/ai/wanderer.lua` module for enemies to wander randomly when the player is outside vision range. Integrated with Shooter AI - they now pick random nearby destinations and move toward them at 50% speed, pausing briefly between targets. Wandering is interrupted immediately when the player is spotted.
- **Implemented Isaac-Style Procedural Dungeon Generation**: Full implementation of PROCGEN.md phases:
  - **Expansion Loop**: Random walk algorithm with "Rule of One" constraint to prevent 2×2 room clusters. Configurable `TARGET_ROOM_COUNT = 8`.
  - **Specialization**: Distance-based room type assignment. Leaf nodes (1 neighbor) are assigned as BOSS (farthest), TREASURE, and SHOP. Remaining rooms become COMBAT with auto-assigned enemies.
  - **Door Connection**: Automatic bidirectional door creation via neighbor lookup.
  - Floor colors now reflect room type (red=boss, cyan=treasure, yellow=shop).
- **Implemented configurable hitboxes** with per-direction support for asymmetric sprites (e.g., laser 14x6 vertical, 6x14 horizontal). Uses `entity.hitbox[direction]` or falls back to `hitbox_*` properties.
- **Implemented FSM-based animation system** with per-frame durations, composite sprites, and velocity-based direction.
- Updated architecture documentation.
- Implemented knockback and invulnerability.
- Fixed palette-aware lighting and spotlight effects.
- Refactored player movement to use ECS (controllable, acceleration, velocity systems).
- Fixed map collision issues.
- Established context workflow in `.agent/workflows/context.md`.
- **Fixed projectile spawning** to always originate from the shooter's center and **implemented layered rendering** (projectiles and pickups are now rendered behind characters).
- **Fixed projectile-map immediate collision bug** by aligning projectile hitboxes with the player's core collision footprint [3, 13] x [4, 16], preventing "protrusion" hits against walls the player is currently touching.
- **Implemented random enemy spawning**: Enemies are now spawned at random positions within the room area, ensuring a minimum distance from the player and avoiding solid tiles.
- **Added room entry timer and blinking visualization**: Enemies now spawn after a 1-second delay upon entering the Play scene. During this delay, sprite 207 is displayed with a blinking effect at the pre-calculated spawn positions to indicate where enemies will appear.
- **Fixed room clipping and unit normalization**: Introduced `ROOM_PIXELS` to handle tile-to-pixel conversion for `ROOM_CLIP`, fixing an issue where spawn indicators and lighting effects were being incorrectly clipped.
- **Fixed enemy spawn overlap logic**: Resolved a crash in `is_free_space` by correcting argument passing and implementing a distance-based check to prevent enemies from spawning on the same pixel.
- **Extracted Spawner System**: Moved enemy spawning logic (random position calculation, timer, and blinking indicators) from `play.lua` into a dedicated `Systems.Spawner` module (`src/systems/spawner.lua`). Cleaned up the coordinate calculation and added support for spawning multiple enemy types.
- **Implemented Shooter Enemy and AI Refactor**: Added a new "Shooter" enemy type with unique AI that maintains distance from the player and fires projectiles. Refactored the AI system to support modular behaviors based on enemy type.
- **Refactored Shadow System to Independent Entities**: Replaced the previous tag-based shadow system with a dedicated `Shadow` entity architecture. Added support for dual-syntax configuration in `constants.lua`: both global/simple properties (`shadow_offset`, `shadow_width`) and per-direction overrides (`shadow_offsets`, `shadow_widths`).
- **Enhanced Animation System Fallbacks**: Updated the animation system to support both directional (nesting under `down`, `up`, etc.) and global (top-level `idle`, `walking`) syntaxes. Implemented a 4-tier fallback: Direction-specific State -> Direction-specific Idle -> Global State -> Global Idle.
- **Refined projectile centering and alignment**: Synchronized hitboxes with flying elevation so they perfectly match the visual sprite. Decoupled shadows from hitbox elevation, anchoring them firmly to the ground line (`entity.y + height`). Implemented per-direction `shadow_offsets` support, allowing for precise grounding as entity sprites change direction.
- **Implemented Isaac-style projectile aerials**: Significantly increased projectile elevation and support for detached shadows (`shadow_offset_y`). Enforced a minimum shadow width of 8px to maintain visual presence for thin projectiles like lasers.
- **Implemented dynamic shadow sizing and aesthetic refinements**: Shadow width and position are now calculated from the entity's hitbox dimensions with professional scaling (80% width) and flattening (3px height). Tucked shadows slightly into the sprite base for a better grounded feel.
- **Enhanced hitbox lookup**: Updated `Collision.get_hitbox` to support `current_direction` as a fallback, ensuring compatibility with the FSM-based animation system.
- **Implemented EnemyProjectile Collisions**: Added collision handlers for `EnemyProjectile` to ensure they are deleted upon hitting walls or the player, and deal damage/knockback to the player.
- **Implemented Sprite Flip Support**: Enhanced the animation and rendering systems to support both horizontal and vertical flips using boolean properties (`flip_x`, `flip_y`). Added support for per-frame flips via a `flips` table in animation configurations.
- **Enabled Projectile Animations**: Updated the animation system to handle simplified directional configs (no state nesting) and added the `animatable` tag to player projectiles, enabling effects like spinning lasers.
- **Implemented Dead Player Deactivation**: Added logic to the animation system to remove active ECS tags (`controllable`, `collidable`, `shooter`, `player`, etc.) from entities upon entering the `death` state. This ensures dead entities are ignored by AI and collisions, and cannot be controlled, while remaining rendered on screen.
- **Implemented Enemy Freeze on Player Death**: Updated the AI system to zero out enemy velocity and direction when no player entity is found, causing enemies to stop in place upon player death.
- **Implemented Enemy Death Animations**: Added procedural death effects for enemies using sprite manipulation:
  - **Squash and Stretch**: Enemies flatten vertically and expand horizontally using `sspr`.
  - **Palette Flash**: Enemies flash white and then flicker red/purple/gray.
  - **Shake**: Added random position jitter.
  - Configured `death` animation state in `GameConstants` with a 30-frame duration.
  - **Fixed death flow**: Removed immediate `world.del()` from collision handler, allowing FSM death state to play animation before cleanup.
- **Implemented Dual Pickup System with Extensible Architecture**:
  - **ProjectilePickup**: Spawned when player projectiles hit walls (maintains directional sprite from projectile).
  - **HealthPickup**: Spawned when enemies die (sprite 64, simple static pickup).
  - **Effect Registry**: Implemented `PickupEffects` registry in collision.lua that maps `pickup_type` to effect handlers.
  - **Type-based Dispatch**: Pickups now have a `pickup_type` field that determines which effect handler runs.
  - **Extensible Design**: New pickup types (ammo, powerups, coins) can be added by:
    1. Adding an effect handler to `PickupEffects` registry
    2. Creating a spawn function with the appropriate `pickup_type`
    3. No changes needed to collision handlers
  - See `docs/PICKUP_SYSTEM.md` for architecture details and examples.
- **Refactored Dungeon Management**: Renamed `RoomManager` to `DungeonManager` and implemented grid-based dungeon generation with safe starts and enemy rooms.
- **Implemented Single-Screen Rendering**: Switched to a model where rooms are carved into the (0,0) map area on each transition, simplifying camera and coordinate management.
- **Implemented Room Locking Mechanics**: Doors now lock (sprite 4) upon room entry and unlock (sprite 3) only after all enemies are defeated. Improved robustness by checking spawner completion state.
- **Enhanced Door Transitions**: Improved door collision detection with multi-point hit checks and reliable player teleportation between rooms.
- **Cleaned Up Logic**: Removed manual solid flag setting in favor of Picotron sprite editor flags and optimized entity cleanup during transitions.
- **Fixed RoomManager Stateful Integration**: Added a top-level `update()` method to `RoomManager` that delegates to the current state's update method, resolving "Undefined field `update`" error when using the Stateful library.
- **Implemented Zelda-style Room Transitions**: Added a `Scrolling` state to `RoomManager` that handles smooth transitions between rooms with camera interpolation.
- **Single Source of Truth (Absolute World Coordinates)**: Refactored the entire coordinate system so that `Room` objects store absolute tile and pixel positions on an extended 80x48 map. This eliminates the need for constant "base offset" additions and guarantees visual consistency across all systems (collision, spawning, rendering).
- **Extended Map System**: Implemented a custom map userdata (`80x48`) that provides margin on all sides of the visible screen area, allowing the previous room's walls to remain visible during transitions (the "peek" effect).
- **Refactored Dungeon and Room Management**:
  - `DungeonManager`: Handles world-level generation, room placement on the grid, map carving, and player spawn calculations.
  - `RoomManager`: Handles the visual state machine (Exploring, Scrolling, Settling) and manages camera offsets and floor rendering.
- **Fixed South Door Collision**: Resolved a coordinate mismatch in `identify_door` by aligning it with the new absolute world coordinate system.
- **Refactored Entity Rendering**: Moved `draw_entity` from `play.lua` to `Systems.draw_entity_with_flash` in `src/systems/rendering.lua` to sanitize the Play scene loop and centralize rendering logic.
- **Accurate Player/Enemy Positioning**: Ensured that the player and enemies spawn correctly within the world coordinate space of each room, fixing rendering bugs after transitions.
- **Code Quality & Linting**: Established pattern of declaring manager instances (e.g., `room_manager` in `play.lua`) as `local` variables rather than globals. This resolves "Undefined field" linting ambiguities and matches the `SceneManager` pattern in `main.lua`.
- **Enhanced Skull Pressure Mechanic**:
  - Skulls now spawn in **locked combat rooms** after a 30-second delay (`SKULL_SPAWN_LOCKED_TIMER = 1800`), adding pressure during combat.
  - Skulls ignore the health check in locked rooms but respect it in cleared rooms (only spawn if player is hurt).
  - Skulls no longer display a health bar (`Rendering.draw_health_bar` skips entities with `skull` tag).
  - Implemented via `onenteractive` and `onentercleared` callbacks in the Room lifecycle FSM.
- **Improved Enemy Balance**:
  - Increased `Dasher` (Snail) vision range by 50% (from 100 to 150) to make it more aggressive in spotting the player.
- **Fixed Spotlight and Shadow Rendering**: The `clip()` function operates in screen coordinates, not world coordinates. When camera offsets are applied, the room's world-space `pixels` must be converted to screen-space by subtracting the camera scroll. This fix ensures spotlights and shadows render correctly regardless of camera position.
- **Implemented Skull Pressure Mechanic**:
  - Introduced a "skull" enemy that spawns in cleared combat rooms after a configurable timer (`SKULL_SPAWN_TIMER = 420` frames/7 seconds).
  - **Logic**: Only spawns if the player is below max health, preventing indefinite idle regeneration without movement.
  - **Properties**: 1 HP, immune to projectiles, deals 20 HP damage (one segment) on contact.
  - **Spawn Logic**: Spawns truly offscreen (32px beyond viewport) at the farthest corner from the player.
  - **Refactoring**: Implemented `map_collidable` ECS tag to distinguish between entity-map and entity-entity collisions. The skull is `collidable` but not `map_collidable`, allowing it to pass through walls.
  - **Cleanup**: `RoomManager` handles skull deletion on room transition and timer reset on re-entry.
- **Implemented Inventory Pickup System**:
  - **New Pickups**: Added `Coin`, `Key`, and `Bomb` configurations to `GameConstants.Pickup`.
  - **Collision Logic**: Registered handlers for `Player` collecting these new items.
  - **Effect Registry**: Implemented separate effect handlers in `PickupEffects` that increment `player.coins`, `player.keys`, `player.bombs`.
  - **Visuals**: Added `pickup_color` (yellow) to `FloatingText` for inventory items.
  - **Architecture**: Extended the data-driven Type Object pattern to support generic inventory items.
- **Implemented Inventory HUD**:
  - **New Module**: `src/ui/hud.lua` renders the inventory state (Coins, Keys, Bombs) on screen.
  - **Configuration**: Added `Hud` section to `game_config.lua` defining sprite IDs (196-198), positions, and spacing.
  - **Integration**: Updated `src/scenes/play.lua` to draw the HUD after the camera reset (UI layer).
- **Refactored Projectile System to Type Object Pattern**:
  - Consolidated `Projectile.spawn` and `Projectile.spawn_enemy` into a single unified `Projectile.spawn(world, x, y, dx, dy, projectile_type, instance_data)` function.
  - Moved all projectile type definitions (`Laser`, `EnemyBullet`) into `GameConstants.Projectile` as pure data objects, mirroring the Enemy system design.
  - Each projectile type config includes: `entity_type`, `tags`, `owner`, `speed`, `damage`, hitbox data, animation configs, shadow settings, and palette swaps.
  - Updated `Entities` module with convenience aliases (`spawn_laser`, `spawn_enemy_projectile`) and preserved backward compatibility.
- **Refactored Pickup System to Type Object Pattern**:
  - Consolidated `Pickup.spawn_projectile` and `Pickup.spawn_health` into a single unified `Pickup.spawn(world, x, y, pickup_type, instance_data)` function.
  - Moved all pickup type definitions (`ProjectilePickup`, `HealthPickup`) into `GameConstants.Pickup` as pure data objects.
  - Each pickup type config includes: `entity_type`, `tags`, `pickup_effect`, sprite settings, and hitbox data.
  - Added `hitbox_from_projectile` flag for pickups that inherit hitbox from projectile types.
  - Updated `Entities` module with generic `spawn_pickup` and convenience aliases for backward compatibility.
- **Unified Type Object Pattern Across All Entity Factories**:
  - All three factories (Enemy, Projectile, Pickup) now follow the same structure:
    1. Signature: `spawn(world, x, y, [type_specific_args], type_key, instance_data)`
    2. Config lookup: `GameConstants.<Category>[type_key]`
    3. Entity properties built from config
    4. Instance overrides applied with generic `for k,v in pairs(instance_data)` loop
    5. Entity created with `Utils.spawn_entity(world, config.tags, entity)` - auto-spawns shadows if tagged
  - Consistent type key naming: `enemy_type`, `projectile_type`, `pickup_type` stored on entities
  - Created shared `entities/utils.lua` with:
    - `get_direction_name(dx, dy, default)` - converts velocity to direction string with thresholding and fallback support.
    - `spawn_entity(world, tags, entity_data)` - centralized entity creation that auto-spawns shadows for entities containing the "shadow" tag.
  - **Data-driven Shadows**: Shadows are no longer manually spawned by factories. Adding the "shadow" tag to any entity in `constants.lua` automatically creates a linked `Shadow` entity via `Utils.spawn_entity`.
  - Added "shadow" tag to entity configs in constants.lua (Laser, EnemyBullet, Skulker, Shooter, Skull, Player).
  - Cleaned up dead code in `entities/init.lua`: removed `spawn_projectile`, `spawn_laser`, `spawn_pickup`, `spawn_shadow`.
  - Renamed to `spawn_player_projectile` and `spawn_enemy_projectile` for clarity.
- **Implemented Dasher Enemy (Snail)**:
  - **Configuration**: Added `Dasher` to `GameConstants.Enemy` with 60 HP (tank), slow speed (0.2), and Patrol/Windup/Dash/Stun behavior parameters.
  - **AI System**: Implemented `dasher_behavior` using `lua-state-machine` FSM:
    - **Patrol**: Random cardinal movement until blocked -> orthogonal turn.
    - **Windup**: 60-frame pause when spotting player, tracking player position.
    - **Dash**: Fast movement (4x speed) towards last seen player position.
    - **Stun**: 120-frame pause after collision with wall/player.
  - **Visuals**: Mapped `attacking` animation state to the "snail in shell" sprite (235) to visually represent the Dash/Shell mode, synchronized via FSM events.
  - **Collision**: Added logic to detect Dasher collisions during Dash state and trigger Stun.
- **Documentation & Task Management**:
  - Updated `ARCHITECTURE.md` to reflect unified factory patterns and data-driven shadows.
  - Updated `TODO.md` status for procedural generation and combat fixes.
- **Refactoring**: Extracted collision handlers from `collision.lua` to `src/systems/handlers.lua` to improve code organization and maintainability.
- **Simplification**: Refactored `src/systems/ai.lua` to use the built-in `sgn()` function for calculating entity directions, replacing complex ternary logic.
- **Implemented Door Guidance (Wall Sliding)**:
  - Added a "guidance" system to map collisions: when the player moves toward a wall tile adjacent to an unlocked door, they are nudged toward the door's center.
  - Centralized tile flags (`SOLID_FLAG`, `DOOR_FLAG`) and door sprites (`SPRITE_DOOR_OPEN`, `SPRITE_DOOR_BLOCKED`) as global constants in `constants.lua`.
  - Updated `Collision.resolve_map` to detect adjacent doors and apply a corrective velocity (1.5x base speed) on the orthogonal axis.
- **Implemented 1x3 Corridors and Visual Refinements**:
  - Expanded corridors between rooms to 1x3 dimensions (1 tile wide, 3 tiles long) with automatically carved walls.
  - **Seamless Transitions**: Unlocked doors are now replaced with tile 0 (empty passage) for a cleaner visual look.
  - **Dynamic Corridor Coloring**: Corridors now match the floor color of the room when it is unlocked, remaining black (background color) while the room is locked.
  - **Stateful Compatibility**: Updated `RoomManager` to use `getStateStackDebugInfo()` for state checks, maintaining compatibility with the third-party `Stateful` library without modification.
- **Implemented Room Lifecycle FSM**: Replaced scattered boolean flags (`spawned`, `is_locked`, `cleared`) with a single `lua-state-machine` FSM on the Room object.
  - **States**: `empty` (safe rooms), `populated` (has enemy config), `spawning` (countdown active), `active` (combat in progress), `cleared` (all enemies dead).
  - **Transitions**: `enter` (populated→spawning), `spawn` (spawning→active), `clear` (active→cleared).
  - **Door Updates**: FSM callbacks handle door sprite changes automatically on state entry.
  - **Consumers Updated**: `RoomManager`, `Spawner`, and `Handlers` now use `room.lifecycle:is()` / `room.lifecycle:can()` instead of flags.
- **Fixed Player Stuck Behind Door Bug**: Adjusted player spawn position calculations in `CameraManager` during room transitions. Now accounts for player width/height when entering from East/South to prevent spawning inside walls/doors (ensures an 8px safe gap).
- **Code Cleanup**: Removed duplicated directions table in `DungeonManager.generate` in favor of the `DIRECTIONS` constant. Removed redundant `is_safe`, `enemy_positions`, and `spawn_timer` initializations in `DungeonManager` as they are now handled by the Lifecycle FSM and `Spawner` system.
- **Implemented Room Screen Centering**:
  - `CameraManager` now automatically centers rooms smaller than the screen.
  - Room dimensions adjusted to 29x16 tiles (464x256 pixels) to create balanced margins.
  - `Room:draw()` now only fills the inner floor bounds (excluding walls) to prevent floor bleed.
  - `DungeonManager.carve_room()` carves extra wall tiles in the margin area (calculated from screen gap) to fill visible space beyond room bounds.
  - `DungeonManager.carve_corridors()` simplified to pierce door tiles in both current and adjacent rooms.
  - Removed manual `MAP_DRAWING_OFFSET` from camera calculation; centering is now fully automatic.
- **Implemented Rotated and Stretched Door Sprites**:
  - Blocked door sprites (sprite 6) are now drawn with rotation so the bottom of the sprite faces the room center.
  - Added `Rendering.draw_doors(room)` function that uses the `sprite_rotator` module to apply direction-based rotation.
  - Rotation angles: North doors: 0°, South doors: 180°, East doors: 90°, West doors: 270°.
  - Doors are stretched using `sspr` to span 1.5 tiles (24 pixels) to cover the gap between wall and floor.
  - `DungeonManager.apply_door_sprites()` sets blocked door tiles to 0 (empty) in the map, allowing manual drawing with rotation and stretching.
- **Restored Dynamic Room Transitions**: When the player's world position exits the current room's pixel bounds (e.g., by entering a door opening), a transition is triggered. The `CameraManager` enters a `Scrolling` state, teleports the player to the entrance of the target room, and smoothly interpolates the camera position from the old room to the new one over 30 frames. During this scroll, both rooms are rendered to the screen. Once complete, the camera returns to its `Following` (clamping) state and the target room becomes the new active room.
- **Room Lifecycle**: Each room has an internal FSM (`populated`, `spawning`, `active`, `cleared`) that controls enemy spawning and door status.
- **1-Tile Walls Between Rooms**: Rooms are placed with a stride of `ROOM_TILES - 1`, overlapping by 1 tile. Simplified carving: `fill_map_with_walls()` fills entire map with walls first, then `carve_room_floor()` carves floors for each room, then `carve_corridors()` clears door tiles.
- **Skull Pressure Mechanic**: Cleared combat rooms initialize a `SKULL_SPAWN_TIMER` (in `constants.lua`). If the player remains in a cleared room while below max health, a projectile-immune "skull" enemy spawns offscreen at the farthest corner to force progression. The skull can pass through walls (`collidable` but not `map_collidable`).
- **Implemented Health-Gated Melee Attack**:
  - **Mechanic**: Added a risk-reward melee attack available only when HP <= max_hp / 5 (one segment).
  - **Logic**: Inflicts dynamic damage `(max_hp - current_hp) / 2` and refunds the health cost on hit (vampiric).
  - **Implementation**: New `systems/melee.lua` checks input/health and spawns a temporary `MeleeHitbox` entity.
  - **Dynamics**: Hitbox moves with the player and always follows facing direction.
  - **Visuals**: Uses sprite 31 rotated to match player direction.
  - **Integration**: Added collision handler in `handlers.lua` to apply damage and healing.
- **Fixed Attack Edge Cases**:
  - **Shooting**: Changed health check from `hp > cost` to `hp >= cost` so player can shoot when HP exactly equals shot cost.
  - **Melee**: Changed health threshold from `hp < threshold` to `hp <= threshold` to allow melee at exactly one segment.
  - **Hitbox Offsets**: Fixed melee hitbox offsets being applied twice (once to position, once to hitbox properties). Now offsets are applied only to position with hitbox offsets set to 0.
- **Implemented Twin-Stick Shooting & Trajectory**:
  - **Control Scheme**: Changed from D-pad shooting to Twin-Stick controls:
    - **Move**: Second D-pad (ESDF/IJKL depending on config).
    - **Aim**: First D-pad (Arrow keys). Shows trajectory line.
    - **Fire**: Button 'O' (Z/N). Fires in aimed direction.
  - **Shooter System Refactor**:
    - Decoupled aiming from firing.
    - Using ECS tags `aiming` (visuals) and `shooting` (trigger) to manage state.
    - Player requires manual fire button press.
    - Enemies fire automatically when `shoot_cooldown == 0`.
  - **Visual Feedback**: Added dashed trajectory lines drawn for entities with the `aiming` tag.
- **Decoupled Animation FSM from Lifecycle**: Refactored `src/systems/animation.lua` and `src/lifecycle/lifecycle.lua` to remove direct dependency.
  - **Animation System**: Now sets `anim_complete_state` and `anim_looping` flags on the entity instead of calling `Lifecycle` directly.
  - **Lifecycle System**: Checks these flags during `update_fsm` to trigger state transitions (Attack Finish -> Idle) or death cleanup.
  - **Result**: Cleaner system boundaries; Animation is now purely visual and data-driven.
